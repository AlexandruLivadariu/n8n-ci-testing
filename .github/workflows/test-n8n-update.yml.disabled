name: Test n8n Version Update

on:
  workflow_dispatch:
    inputs:
      n8n_version:
        description: 'n8n version to test (e.g., 1.30.0 or latest)'
        required: true
        default: 'latest'

jobs:
  test-update:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Pull n8n version ${{ github.event.inputs.n8n_version }}
        run: |
          docker pull n8nio/n8n:${{ github.event.inputs.n8n_version }}
      
      - name: Update test instance with new version
        run: |
          cd docker
          # Modify docker-compose to use specified version
          sed -i 's|image: n8nio/n8n:.*|image: n8nio/n8n:${{ github.event.inputs.n8n_version }}|' docker-compose.test.yml
          docker-compose -f docker-compose.test.yml up -d
          sleep 45
      
      - name: Check n8n version
        run: |
          docker exec n8n-test n8n --version
      
      - name: Import workflows
        env:
          N8N_TEST_API_KEY: ${{ secrets.N8N_TEST_API_KEY }}
        run: |
          cd scripts
          ./import-workflows.sh test
      
      - name: Run full test suite
        env:
          N8N_TEST_API_KEY: ${{ secrets.N8N_TEST_API_KEY }}
        run: |
          cd scripts
          ./run-tests.sh
      
      - name: Generate version test report
        if: always()
        run: |
          echo "# n8n Version Test Report" > version-test-report.md
          echo "" >> version-test-report.md
          echo "**Tested Version:** ${{ github.event.inputs.n8n_version }}" >> version-test-report.md
          echo "**Date:** $(date)" >> version-test-report.md
          echo "" >> version-test-report.md
          echo "## Test Results" >> version-test-report.md
          cat logs/test-results.log >> version-test-report.md || true
      
      - name: Upload version test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: version-test-report
          path: version-test-report.md
      
      - name: Cleanup
        if: always()
        run: |
          cd docker
          docker-compose -f docker-compose.test.yml down
          # Restore original docker-compose file
          git checkout docker-compose.test.yml