name: Test n8n Workflows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: n8n-test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: self-hosted  
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Docker is running
        run: |
          docker --version
          docker-compose --version
      
      - name: Stop existing test instance (if running)
        run: |
          cd docker
          docker-compose -f docker-compose.test.yml down -v --remove-orphans || true
        continue-on-error: true
      
      - name: Start n8n test instance
        run: |
          cd docker
          echo "Starting n8n test instance..."
          docker-compose -f docker-compose.test.yml up -d --remove-orphans
          
          echo "Checking if containers started..."
          docker ps | grep n8n-test || (echo "Container failed to start!" && docker ps -a && exit 1)
          
          echo "Waiting for containers to initialize..."
          sleep 60
      
      - name: Wait for database to be ready
        run: |
          echo "Waiting for database initialization..."
          for i in {1..30}; do
            if docker exec n8n-postgres-test pg_isready -U n8n > /dev/null 2>&1; then
              echo "✅ Database is ready!"
              break
            fi
            echo "Waiting for database... ($i/30)"
            sleep 2
          done
          
          echo "Checking n8n-test container status..."
          docker ps -a | grep n8n-test || echo "n8n-test container not found!"
          
          if docker ps | grep -q n8n-test; then
            echo "✅ n8n-test container is running"
            echo "Container logs:"
            docker logs n8n-test --tail 30
          else
            echo "❌ n8n-test container is not running!"
            echo "All containers:"
            docker ps -a
            exit 1
          fi
      
      - name: Check n8n is ready
        run: |
          echo "Checking n8n container..."
          echo "Waiting for n8n to be ready..."
          
          # Wait for n8n web interface - access via container IP or localhost
          for i in {1..30}; do
            # Try localhost first (works if ports are properly exposed)
            if timeout 5 curl -s http://localhost:5679 > /dev/null 2>&1; then
              echo "✅ n8n web interface is responding on localhost"
              break
            fi
            # Try via docker exec as fallback
            if docker exec n8n-test wget -q -O- http://localhost:5678 > /dev/null 2>&1; then
              echo "✅ n8n is responding inside container"
              break
            fi
            echo "Waiting for n8n... ($i/30)"
            sleep 2
          done
          
          echo "Container logs:"
          docker logs n8n-test --tail 20
      
      - name: Setup owner account
        run: |
          echo "Setting up owner account..."
          
          # Setup owner via docker exec (direct container access)
          RESPONSE=$(docker exec n8n-test wget -q -O- --post-data='{"email":"ci@test.local","firstName":"CI","lastName":"Test","password":"TestPassword123!"}' \
            --header='Content-Type: application/json' \
            http://localhost:5678/rest/owner/setup 2>&1 || echo "failed")
          
          if echo "$RESPONSE" | grep -q "email"; then
            echo "✅ Owner setup complete"
          else
            echo "⚠️ Owner setup may have failed or already exists: $RESPONSE"
          fi
          
          sleep 5
      
      - name: Create API key for CI
        id: create_api_key
        run: |
          echo "Creating API key for CI tests..."
          
          # Wait a bit more for n8n to be fully ready
          sleep 10
          
          # Login to get session cookie
          echo "Logging in to n8n..."
          COOKIE=$(docker exec n8n-test sh -c 'wget -q -O- --save-cookies=/tmp/cookies.txt --keep-session-cookies --post-data="{\"email\":\"ci@test.local\",\"password\":\"TestPassword123!\"}" --header="Content-Type: application/json" http://localhost:5678/rest/login 2>&1 && cat /tmp/cookies.txt | grep -v "^#" | awk "{print \$6\"=\"\$7}" | tr "\n" ";"' 2>&1)
          
          echo "Cookie: ${COOKIE:0:50}..."
          
          if [ -z "$COOKIE" ]; then
            echo "❌ Failed to login"
            exit 1
          fi
          
          # Create API key via n8n's API
          echo "Creating API key via n8n API..."
          API_RESPONSE=$(docker exec n8n-test wget -q -O- \
            --header="Cookie: $COOKIE" \
            --header="Content-Type: application/json" \
            --post-data='{"label":"CI-Test"}' \
            http://localhost:5678/rest/api-keys 2>&1)
          
          echo "API Response: ${API_RESPONSE:0:200}"
          
          # Extract the API key from response
          API_KEY=$(echo "$API_RESPONSE" | grep -oP '"apiKey":"[^"]+' | cut -d'"' -f4)
          
          if [ -z "$API_KEY" ]; then
            echo "❌ Failed to create API key"
            echo "Full response: $API_RESPONSE"
            exit 1
          fi
          
          echo "API_KEY=$API_KEY" >> $GITHUB_OUTPUT
          echo "✅ API key created via n8n API"
      
      - name: Verify API access
        env:
          N8N_TEST_API_KEY: ${{ steps.create_api_key.outputs.API_KEY }}
        run: |
          echo "Verifying API access with generated key..."
          echo "API Key (first 50 chars): ${N8N_TEST_API_KEY:0:50}..."
          
          # Debug: Check what n8n sees
          echo "Checking n8n environment..."
          docker exec n8n-test printenv | grep N8N_JWT_SECRET || true
          
          # Debug: Verify API key in database
          echo "API keys in database:"
          docker exec n8n-postgres-test psql -U n8n -d n8n -c "SELECT id, \"userId\", label, LEFT(\"apiKey\", 50) as key_start FROM user_api_keys;" 2>&1 || true
          
          # Try API access
          for i in {1..5}; do
            echo "Attempt $i..."
            
            # Use wget with proper error handling
            set +e  # Temporarily disable exit on error
            RESPONSE=$(docker exec n8n-test wget -q -O- --header="X-N8N-API-KEY: $N8N_TEST_API_KEY" http://localhost:5678/api/v1/workflows 2>&1)
            EXIT_CODE=$?
            set -e  # Re-enable exit on error
            
            echo "Exit code: $EXIT_CODE"
            echo "Response: ${RESPONSE:0:200}"
            
            if [ $EXIT_CODE -eq 0 ] && echo "$RESPONSE" | grep -q "data"; then
              echo "✅ n8n API is ready!"
              exit 0
            fi
            
            if echo "$RESPONSE" | grep -q "401 Unauthorized"; then
              echo "❌ Getting 401 Unauthorized - JWT validation failed"
              echo "This means the API key is not being accepted by n8n"
            elif echo "$RESPONSE" | grep -q "404"; then
              echo "❌ Getting 404 - API endpoint not found"
            fi
            
            sleep 3
          done
          
          echo ""
          echo "❌ n8n API failed to respond correctly after 5 attempts"
          echo ""
          echo "Debugging information:"
          echo "1. Checking if n8n is actually running:"
          docker exec n8n-test ps aux | grep node || true
          echo ""
          echo "2. Testing basic connectivity:"
          docker exec n8n-test wget -q -O- http://localhost:5678 2>&1 | head -20 || true
          echo ""
          echo "3. Checking n8n logs:"
          docker logs n8n-test 2>&1 | tail -50
          exit 1
      
      - name: Import workflows to test instance
        env:
          N8N_TEST_API_KEY: ${{ steps.create_api_key.outputs.API_KEY }}
        run: |
          cd scripts
          ./import-workflows.sh test
      
      - name: Run smoke tests
        env:
          N8N_TEST_API_KEY: ${{ steps.create_api_key.outputs.API_KEY }}
        run: |
          cd scripts
          ./run-tests.sh
      
      - name: Generate test report
        if: always()
        run: |
          echo "# Test Report" > test-report.md
          echo "" >> test-report.md
          echo "**Date:** $(date)" >> test-report.md
          echo "**Commit:** ${{ github.sha }}" >> test-report.md
          echo "" >> test-report.md
          if [ -f logs/test-results.log ]; then
            cat logs/test-results.log >> test-report.md
          fi
          echo "Test report saved to test-report.md"
          cat test-report.md
      
      - name: Cleanup - Stop test instance
        if: always()
        run: |
          cd docker
          docker-compose -f docker-compose.test.yml down
      
      - name: Test result
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ All tests passed!"
          else
            echo "❌ Tests failed"
            exit 1
          fi