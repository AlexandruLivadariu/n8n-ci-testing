name: Test n8n Workflows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test:
    runs-on: self-hosted  # This will run on your local machine
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Docker is running
        run: |
          docker --version
          docker-compose --version
      
      - name: Stop existing test instance (if running)
        run: |
          cd docker
          docker-compose -f docker-compose.test.yml down || true
        continue-on-error: true
      
      - name: Start n8n test instance
        run: |
          cd docker
          docker-compose -f docker-compose.test.yml up -d
          echo "Waiting for n8n to start..."
          sleep 60
      
      - name: Wait for database to be ready
        run: |
          echo "Waiting for database initialization..."
          for i in {1..30}; do
            if docker exec n8n-postgres-test pg_isready -U n8n > /dev/null 2>&1; then
              echo "✅ Database is ready!"
              break
            fi
            echo "Waiting for database... ($i/30)"
            sleep 2
          done
      
      - name: Check n8n is ready
        run: |
          echo "Checking n8n at http://localhost:5679"
          echo "Waiting for n8n to be ready..."
          
          # Wait for n8n web interface
          for i in {1..30}; do
            if curl -s http://localhost:5679 > /dev/null 2>&1; then
              echo "✅ n8n web interface is responding"
              break
            fi
            echo "Waiting for n8n web interface... ($i/30)"
            sleep 2
          done
          
          echo "Container logs:"
          docker logs n8n-test --tail 20
      
      - name: Setup owner account
        run: |
          echo "Setting up owner account..."
          
          # Try to setup owner via API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:5679/rest/owner/setup \
            -H "Content-Type: application/json" \
            -d '{
              "email": "ci@test.local",
              "firstName": "CI",
              "lastName": "Test",
              "password": "TestPassword123!"
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "Setup response code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "400" ]; then
            echo "✅ Owner setup complete (or already exists)"
          else
            echo "⚠️ Owner setup returned $HTTP_CODE - may already be configured"
          fi
          
          sleep 5
      
      - name: Verify API access
        env:
          N8N_TEST_API_KEY: ${{ secrets.N8N_TEST_API_KEY }}
        run: |
          echo "Verifying API access..."
          
          for i in {1..20}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-N8N-API-KEY: $N8N_TEST_API_KEY" http://localhost:5679/api/v1/workflows 2>&1)
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ n8n API is ready! (HTTP $HTTP_CODE)"
              exit 0
            fi
            
            echo "Waiting for n8n API... ($i/20) - HTTP $HTTP_CODE"
            sleep 3
          done
          
          echo "❌ n8n API failed to respond"
          echo "Final container logs:"
          docker logs n8n-test --tail 50
          exit 1
      
      - name: Import workflows to test instance
        env:
          N8N_TEST_API_KEY: ${{ secrets.N8N_TEST_API_KEY }}
        run: |
          cd scripts
          ./import-workflows.sh test
      
      - name: Run smoke tests
        env:
          N8N_TEST_API_KEY: ${{ secrets.N8N_TEST_API_KEY }}
        run: |
          cd scripts
          ./run-tests.sh
      
      - name: Generate test report
        if: always()
        run: |
          echo "# Test Report" > test-report.md
          echo "" >> test-report.md
          echo "**Date:** $(date)" >> test-report.md
          echo "**Commit:** ${{ github.sha }}" >> test-report.md
          echo "" >> test-report.md
          if [ -f logs/test-results.log ]; then
            cat logs/test-results.log >> test-report.md
          fi
      
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-report.md
      
      - name: Cleanup - Stop test instance
        if: always()
        run: |
          cd docker
          docker-compose -f docker-compose.test.yml down
      
      - name: Test result
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ All tests passed!"
          else
            echo "❌ Tests failed"
            exit 1
          fi