name: n8n Update Pipeline

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Target n8n version (e.g., latest, 1.20.0)'
        required: true
        default: 'latest'
      skip_backup:
        description: 'Skip backup creation (not recommended)'
        required: false
        type: boolean
        default: false

concurrency:
  group: n8n-update
  cancel-in-progress: false

jobs:
  update:
    runs-on: self-hosted
    timeout-minutes: 30
    
    env:
      N8N_TEST_API_KEY: ${{ secrets.N8N_TEST_API_KEY }}
      N8N_DB_PASSWORD: ${{ secrets.N8N_DB_PASSWORD }}
      NO_PROXY: localhost,127.0.0.1
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Pipeline Information
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë         n8n Update Pipeline - Production Template         ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT: This pipeline is designed for updating a"
          echo "   RUNNING n8n production instance, not for CI/CD testing."
          echo ""
          echo "Prerequisites:"
          echo "  ‚úÖ n8n instance must be running (n8n-test or n8n-dev)"
          echo "  ‚úÖ Docker containers must be accessible"
          echo "  ‚úÖ Backup location must be writable"
          echo ""
          echo "For CI/CD testing, use: 'test-workflows' pipeline"
          echo ""
          echo "Target version: ${{ inputs.target_version }}"
          echo "Skip backup: ${{ inputs.skip_backup }}"
          echo ""
      
      - name: Set backup timestamp
        id: backup_info
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "Backup timestamp: ${TIMESTAMP}"
      
      - name: Create backup
        if: ${{ !inputs.skip_backup }}
        continue-on-error: true
        run: |
          echo "‚ö†Ô∏è  Checking for running n8n instance..."
          
          # Check if n8n-test or n8n-dev is running
          if docker ps --filter "name=n8n-test" --format "{{.Names}}" 2>/dev/null | grep -q "^n8n-test$" || \
             docker ps --filter "name=n8n-dev" --format "{{.Names}}" 2>/dev/null | grep -q "^n8n-dev$"; then
            echo "‚úÖ n8n instance found, creating backup..."
            cd scripts
            chmod +x backup.sh
            ./backup.sh
            echo "‚úÖ Backup created: ${{ steps.backup_info.outputs.timestamp }}"
          else
            echo "‚ö†Ô∏è  No running n8n instance found"
            echo "   Backup requires a running instance (n8n-test or n8n-dev)"
            echo "   Skipping backup step"
            echo ""
            echo "This pipeline is designed for updating an existing n8n deployment."
            echo "For CI/CD testing, use the 'test-workflows' pipeline instead."
          fi
      
      - name: Run pre-update tests
        id: pre_tests
        continue-on-error: true
        run: |
          echo "üß™ Running pre-update tests to establish baseline..."
          echo ""
          
          # Check if n8n instance is running
          if docker ps --filter "name=n8n-test" --format "{{.Names}}" 2>/dev/null | grep -q "^n8n-test$" || \
             docker ps --filter "name=n8n-dev" --format "{{.Names}}" 2>/dev/null | grep -q "^n8n-dev$"; then
            echo "‚úÖ n8n instance found, running tests..."
            cd tests
            chmod +x runner.sh
            ./runner.sh --mode=update --phase=pre-update
            echo "‚úÖ Pre-update tests completed"
          else
            echo "‚ö†Ô∏è  No running n8n instance found"
            echo "   Skipping pre-update tests"
            echo ""
            echo "This pipeline requires a running n8n instance."
            echo "For CI/CD testing, use the 'test-workflows' pipeline instead."
            
            # Create dummy results
            mkdir -p results state
            echo '{"status":"skipped","reason":"no running instance"}' > results/pre-update-report.json
          fi
      
      - name: Save baseline
        run: |
          mkdir -p tests/state
          if [ -f tests/state/baseline.json ]; then
            cp tests/state/baseline.json tests/state/baseline-backup.json
            echo "‚úÖ Baseline saved"
          else
            echo "‚ö†Ô∏è  No baseline found (first run)"
            echo '{"status":"no_baseline"}' > tests/state/baseline.json
          fi
      
      - name: Apply update
        id: update
        continue-on-error: true
        run: |
          echo "üîÑ Applying n8n update to version: ${{ inputs.target_version }}"
          echo ""
          
          # Check if n8n instance is running
          if docker ps --filter "name=n8n-test" --format "{{.Names}}" 2>/dev/null | grep -q "^n8n-test$"; then
            echo "‚úÖ Found running n8n-test instance"
            cd scripts
            chmod +x update.sh
            
            # Run update and capture exit code
            if ./update.sh ${{ inputs.target_version }}; then
              echo "update_status=success" >> $GITHUB_OUTPUT
              echo "‚úÖ Update completed successfully"
            else
              echo "update_status=failed" >> $GITHUB_OUTPUT
              echo "‚ùå Update failed - will evaluate rollback"
            fi
          elif docker ps --filter "name=n8n-dev" --format "{{.Names}}" 2>/dev/null | grep -q "^n8n-dev$"; then
            echo "‚úÖ Found running n8n-dev instance"
            cd scripts
            chmod +x update.sh
            # Update the config to use n8n-dev instead of n8n-test
            sed -i 's/container_name: "n8n-test"/container_name: "n8n-dev"/' ../tests/config.yaml
            
            # Run update and capture exit code
            if ./update.sh ${{ inputs.target_version }}; then
              echo "update_status=success" >> $GITHUB_OUTPUT
              echo "‚úÖ Update completed successfully"
            else
              echo "update_status=failed" >> $GITHUB_OUTPUT
              echo "‚ùå Update failed - will evaluate rollback"
            fi
          else
            echo "‚ùå No running n8n instance found (n8n-test or n8n-dev)"
            echo ""
            echo "This pipeline requires a running n8n instance to update."
            echo "For CI/CD testing with a fresh instance, use 'test-workflows' pipeline."
            echo ""
            echo "update_status=skipped" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Run post-update tests
        id: post_tests
        continue-on-error: true
        run: |
          echo "üß™ Running post-update tests to validate update..."
          echo ""
          
          if [ "${{ steps.update.outputs.update_status }}" == "success" ]; then
            echo "‚úÖ Update was successful, running validation tests..."
            cd tests
            chmod +x runner.sh
            ./runner.sh --mode=update --phase=post-update
            echo "‚úÖ Post-update tests completed"
          else
            echo "‚ö†Ô∏è  Update was skipped, no post-update tests to run"
            
            # Create dummy results
            mkdir -p results state
            echo '{"status":"skipped","reason":"no update performed"}' > results/post-update-report.json
            echo '{"rollback_needed":false,"reason":"no update to validate"}' > state/rollback-decision.json
          fi
      
      - name: Evaluate rollback decision
        id: rollback_decision
        run: |
          # Check if update failed
          if [ "${{ steps.update.outputs.update_status }}" == "failed" ]; then
            echo "rollback_needed=true" >> $GITHUB_OUTPUT
            echo "reason=Update failed - n8n container did not start successfully" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  ROLLBACK REQUIRED: Update failed"
            exit 0
          fi
          
          # Check test results
          if [ -f tests/state/rollback-decision.json ]; then
            ROLLBACK_NEEDED=$(jq -r '.rollback_needed // .should_rollback // false' tests/state/rollback-decision.json)
            REASON=$(jq -r '.reason // "unknown"' tests/state/rollback-decision.json)
            
            echo "rollback_needed=${ROLLBACK_NEEDED}" >> $GITHUB_OUTPUT
            echo "reason=${REASON}" >> $GITHUB_OUTPUT
            
            if [ "$ROLLBACK_NEEDED" == "true" ]; then
              echo "‚ö†Ô∏è  ROLLBACK REQUIRED: ${REASON}"
            else
              echo "‚úÖ Update successful, no rollback needed"
            fi
          else
            echo "‚ö†Ô∏è  No rollback decision found, assuming success"
            echo "rollback_needed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Execute rollback
        if: steps.rollback_decision.outputs.rollback_needed == 'true'
        run: |
          echo "‚èÆÔ∏è  Executing automatic rollback..."
          cd scripts
          chmod +x rollback.sh
          ./rollback.sh ${{ steps.backup_info.outputs.timestamp }}
          echo "‚úÖ Rollback completed"
      
      - name: Send notification
        if: always()
        run: |
          echo "================================"
          echo "n8n Update Pipeline Results"
          echo "================================"
          echo ""
          echo "Pipeline Status: ${{ steps.rollback_decision.outputs.rollback_needed == 'true' && '‚ö†Ô∏è  ROLLED BACK' || '‚úÖ SUCCESS' }}"
          echo "Target Version: ${{ inputs.target_version }}"
          echo "Pre-update tests: ${{ steps.pre_tests.outcome }}"
          echo "Update: ${{ steps.update.outcome }}"
          echo "Post-update tests: ${{ steps.post_tests.outcome }}"
          echo ""
          if [ "${{ steps.rollback_decision.outputs.rollback_needed }}" == "true" ]; then
            echo "Rollback Reason: ${{ steps.rollback_decision.outputs.reason }}"
          fi
          echo ""
          echo "View full results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      
      - name: Save test results
        if: always()
        run: |
          echo "Test results saved locally in tests/results/"
          echo "Skipping artifact upload to avoid pipeline hang"
          echo ""
          if [ -d tests/results ]; then
            echo "Available results:"
            ls -lh tests/results/ || echo "No results directory"
          fi
          if [ -d tests/state ]; then
            echo "Available state files:"
            ls -lh tests/state/ || echo "No state directory"
          fi
      
      - name: Final status
        if: always()
        run: |
          echo "================================"
          echo "Update Pipeline Summary"
          echo "================================"
          echo ""
          echo "‚ö†Ô∏è  This pipeline is a template for production updates"
          echo ""
          echo "Current status: Template mode"
          echo "Target version: ${{ inputs.target_version }}"
          echo ""
          echo "To use this pipeline in production:"
          echo "  1. Ensure n8n instance is running"
          echo "  2. Verify scripts/update.sh works"
          echo "  3. Test locally first"
          echo "  4. Configure backup location"
          echo "  5. Set up SMTP for notifications"
          echo ""
          echo "For automated testing, use 'test-workflows' pipeline instead"
