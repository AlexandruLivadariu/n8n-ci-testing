name: n8n Update Pipeline

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Target n8n version (e.g., latest, 1.20.0)'
        required: true
        default: 'latest'
      skip_backup:
        description: 'Skip backup creation (not recommended)'
        required: false
        type: boolean
        default: false

concurrency:
  group: n8n-update
  cancel-in-progress: false

jobs:
  update:
    runs-on: self-hosted
    timeout-minutes: 30
    
    env:
      N8N_TEST_API_KEY: ${{ secrets.N8N_TEST_API_KEY }}
      N8N_DB_PASSWORD: ${{ secrets.N8N_DB_PASSWORD }}
      NO_PROXY: localhost,127.0.0.1
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set backup timestamp
        id: backup_info
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "Backup timestamp: ${TIMESTAMP}"
      
      - name: Create backup
        if: ${{ !inputs.skip_backup }}
        run: |
          cd scripts
          chmod +x backup.sh
          ./backup.sh
          echo "✅ Backup created: ${{ steps.backup_info.outputs.timestamp }}"
      
      - name: Run pre-update tests
        id: pre_tests
        continue-on-error: true
        run: |
          echo "⚠️  Note: Update pipeline requires a running n8n instance"
          echo "   For now, skipping pre-update tests"
          echo "   This pipeline is designed for updating an existing instance"
          echo ""
          echo "To use this pipeline:"
          echo "  1. Ensure n8n-test or n8n-dev is running"
          echo "  2. Trigger this workflow"
          echo ""
          echo "For testing updates in CI/CD, use the test-workflows pipeline instead"
          
          # Create dummy results for now
          mkdir -p tests/results tests/state
          echo '{"status":"skipped","reason":"no running instance"}' > tests/results/pre-update-report.json
      
      - name: Save baseline
        run: |
          mkdir -p tests/state
          if [ -f tests/state/baseline.json ]; then
            cp tests/state/baseline.json tests/state/baseline-backup.json
            echo "✅ Baseline saved"
          else
            echo "⚠️  No baseline found (first run)"
            echo '{"status":"no_baseline"}' > tests/state/baseline.json
          fi
      
      - name: Apply update
        id: update
        run: |
          echo "⚠️  Update step requires manual implementation"
          echo ""
          echo "This pipeline is a template for updating a running n8n instance."
          echo "To implement:"
          echo "  1. Ensure scripts/update.sh works with your deployment"
          echo "  2. Test locally first"
          echo "  3. Then trigger this pipeline"
          echo ""
          echo "For now, marking as skipped"
          echo "update_status=skipped" >> $GITHUB_OUTPUT
      
      - name: Run post-update tests
        id: post_tests
        continue-on-error: true
        run: |
          echo "⚠️  Post-update tests skipped (no update performed)"
          
          # Create dummy results
          mkdir -p tests/results tests/state
          echo '{"status":"skipped","reason":"no update performed"}' > tests/results/post-update-report.json
          echo '{"should_rollback":false,"reason":"no update to validate"}' > tests/state/rollback-decision.json
      
      - name: Evaluate rollback decision
        id: rollback_decision
        run: |
          if [ -f tests/state/rollback-decision.json ]; then
            SHOULD_ROLLBACK=$(grep -o '"should_rollback": *[^,}]*' tests/state/rollback-decision.json | awk '{print $2}' | tr -d '"')
            REASON=$(grep -o '"reason": *"[^"]*"' tests/state/rollback-decision.json | cut -d'"' -f4)
            
            echo "should_rollback=${SHOULD_ROLLBACK}" >> $GITHUB_OUTPUT
            echo "reason=${REASON}" >> $GITHUB_OUTPUT
            
            if [ "$SHOULD_ROLLBACK" == "true" ]; then
              echo "⚠️  ROLLBACK REQUIRED: ${REASON}"
            else
              echo "✅ Update successful, no rollback needed"
            fi
          else
            echo "⚠️  No rollback decision found, assuming success"
            echo "should_rollback=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Execute rollback
        if: steps.rollback_decision.outputs.should_rollback == 'true'
        run: |
          cd scripts
          chmod +x rollback.sh
          ./rollback.sh ${{ steps.backup_info.outputs.timestamp }}
          echo "✅ Rollback completed"
      
      - name: Send notification
        if: always()
        run: |
          # Simple email notification without SMTP configuration
          # Results are available in GitHub Actions artifacts
          echo "Pipeline Status: ${{ steps.rollback_decision.outputs.should_rollback == 'true' && 'ROLLED BACK' || 'SUCCESS' }}"
          echo "Target Version: ${{ inputs.target_version }}"
          echo "Pre-update tests: ${{ steps.pre_tests.outcome }}"
          echo "Update: ${{ steps.update.outcome }}"
          echo "Post-update tests: ${{ steps.post_tests.outcome }}"
          echo ""
          echo "Email alexandru-valentin.livadariu@atos.net with results"
          echo "View full results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      
      - name: Upload test reports
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ steps.backup_info.outputs.timestamp }}
          path: |
            tests/results/*.json
            tests/state/*.json
          retention-days: 30
          if-no-files-found: warn
      
      - name: Final status
        if: always()
        run: |
          echo "================================"
          echo "Update Pipeline Summary"
          echo "================================"
          echo ""
          echo "⚠️  This pipeline is a template for production updates"
          echo ""
          echo "Current status: Template mode"
          echo "Target version: ${{ inputs.target_version }}"
          echo ""
          echo "To use this pipeline in production:"
          echo "  1. Ensure n8n instance is running"
          echo "  2. Verify scripts/update.sh works"
          echo "  3. Test locally first"
          echo "  4. Configure backup location"
          echo "  5. Set up SMTP for notifications"
          echo ""
          echo "For automated testing, use 'test-workflows' pipeline instead"
